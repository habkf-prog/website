<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>M3U Tool</title>

<style>
:root{
  --bg:#0b0f17; --card:#ffffff10; --line:#ffffff20; --text:#e9eef7; --muted:#b7bfd0;
  --accent:#7c5cff; --ok:#22c55e; --err:#ef4444; --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);padding:18px}
.card{max-width:980px;margin:auto;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px}
h1{margin:0 0 6px}
.muted{color:var(--muted);font-size:13px}
.badge{display:inline-block;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px;color:var(--muted);margin-bottom:10px}
label{display:block;margin-top:14px;font-weight:700}
textarea,input{
  width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid var(--line);
  background:#00000040;color:var(--text)
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.row>*{flex:1;min-width:220px}
button{
  padding:12px;border-radius:14px;border:1px solid var(--accent);
  background:linear-gradient(135deg,var(--accent),#4f46e5);color:#fff;font-weight:800;cursor:pointer
}
button.secondary{
  background:#00000040;border-color:var(--line);color:var(--text)
}
button:disabled{opacity:.6}
.progress-box{display:none;margin-top:14px}
.progress{height:14px;background:#00000050;border-radius:10px;overflow:hidden;border:1px solid var(--line)}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--ok));transition:width .25s}
.log{
  margin-top:14px;padding:12px;background:#00000040;border-radius:14px;border:1px solid var(--line);
  white-space:pre-wrap;font-size:13px
}
.small{font-size:12px;color:var(--muted);margin-top:8px}
hr{border:0;border-top:1px solid var(--line);margin:14px 0}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.modal-content{
  background:#0b0f17;border:1px solid #22c55e55;border-radius:20px;padding:30px 40px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.5);animation:successBounce .45s ease-out;
}
.checkmark{width:80px;height:80px;border-radius:50%;background:#22c55e;color:#fff;font-size:44px;font-weight:900;display:flex;align-items:center;justify-content:center;margin:0 auto 14px}
.modal-text{font-size:16px;font-weight:800}
@keyframes successBounce{
  0%{transform:scale(.7);opacity:0}
  60%{transform:scale(1.05);opacity:1}
  80%{transform:scale(.97)}
  100%{transform:scale(1)}
}
</style>
</head>

<body>
<div class="card">
  <div class="badge">V2 ØªØ´Ø®ÙŠØµ â€” Ø¥Ø°Ø§ Ø±Ø£ÙŠØªÙ‡Ø§ ÙØ§Ù„ØªØ­Ø¯ÙŠØ« Ù†Ø¬Ø­ âœ…</div>
  <h1>ğŸ“º Ø£Ø¯Ø§Ø© Ø¯Ù…Ø¬ M3U</h1>
  <div class="muted">Ø¯Ù…Ø¬ + ØªØ´Ø®ÙŠØµ ÙˆØ§Ø¶Ø­ (ÙŠØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)</div>

  <label>Ø±ÙˆØ§Ø¨Ø· M3U (ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø±):</label>
  <textarea id="urls" placeholder="Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· RAW Ù‡Ù†Ø§... Ù…Ø«Ø§Ù„:
https://raw.githubusercontent.com/USER/REPO/main/list.m3u"></textarea>

  <label>Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª M3U:</label>
  <input type="file" id="files" multiple accept=".m3u,.m3u8,text/plain">

  <div class="row">
    <label><input type="checkbox" id="dedup" checked> Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ±Ø±</label>
    <label><input type="checkbox" id="sort"> ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ</label>
  </div>

  <div class="row">
    <input id="outname" value="merged.m3u">
    <button id="start">Ø¯Ù…Ø¬ ÙˆØªÙ†Ø²ÙŠÙ„</button>
    <button class="secondary" id="diag">ØªØ´Ø®ÙŠØµ ÙÙ‚Ø·</button>
  </div>

  <div class="progress-box" id="progressBox">
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  </div>

  <div class="log" id="log">Ø¬Ø§Ù‡Ø².</div>

  <hr>

  <label>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ (Ø§Ù†Ø³Ø®Ù‡ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„ÙŠ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©):</label>
  <textarea id="report" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‡Ù†Ø§..."></textarea>
  <div class="small">Ù†ØµÙŠØ­Ø©: Ø¥Ø°Ø§ Ø¸Ù‡Ø± HTMLØŸ Ù†Ø¹Ù… â†’ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØ³ M3U (ØºØ§Ù„Ø¨Ù‹Ø§ ØµÙØ­Ø© GitHub blob ÙˆÙ„ÙŠØ³Øª raw).</div>
</div>

<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="checkmark">âœ”</div>
    <div class="modal-text">ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­</div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
function log(msg){ $("log").textContent = msg; }
function setProgress(p){ $("progressBar").style.width = p + "%"; }
function setReport(text){ $("report").value = text; }

function looksLikeHTML(text){
  const t=(text||"").trim().slice(0,300).toLowerCase();
  return t.startsWith("<!doctype html") || t.startsWith("<html") || t.includes("<head") || t.includes("<body");
}
function countExtinf(text){
  const m=(text||"").match(/^#EXTINF:/gm);
  return m ? m.length : 0;
}
function parseM3U(text){
  const lines=(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let list=[], ext=null;
  for(const l of lines){
    if(l.startsWith("#EXTM3U")) continue;
    if(l.startsWith("#EXTINF")){ ext=l; continue; }
    if(l.startsWith("#")) continue;
    list.push({ext: ext || "#EXTINF:-1,Unknown", url:l});
    ext=null;
  }
  return list;
}

async function fetchText(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.text();
}
async function readFile(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result||"");
    fr.onerror=rej;
    fr.readAsText(file);
  });
}
function download(name,text){
  const blob=new Blob([text],{type:"audio/x-mpegurl;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=(name && name.trim()) ? name.trim() : "merged.m3u";
  a.click();
  URL.revokeObjectURL(a.href);
}

async function run({downloadFile}){
  const urls=$("urls").value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const files=[...$("files").files];
  const total=urls.length+files.length;

  if(!total){
    log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø±. Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª.");
    setReport("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„ØªØ´Ø®ÙŠØµÙ‡.");
    return;
  }

  $("start").disabled=true;
  $("diag").disabled=true;
  $("progressBox").style.display="block";
  setProgress(0);
  setReport("");

  let entries=[], done=0, ok=0, fail=0;
  let reportLines=[];

  try{
    // URLs
    for(const u of urls){
      try{
        const t=await fetchText(u);
        const ext=countExtinf(t);
        const html=looksLikeHTML(t);
        const parsed=parseM3U(t);
        entries.push(...parsed);
        ok++;
        reportLines.push(
          `âœ… URL: ${u}\n` +
          `   - HTTP: OK\n` +
          `   - HTMLØŸ ${html ? "Ù†Ø¹Ù…" : "Ù„Ø§"}\n` +
          `   - EXTINF: ${ext}\n` +
          `   - Parsed URLs: ${parsed.length}\n`
        );
      }catch(e){
        fail++;
        reportLines.push(`âŒ URL: ${u}\n   - ERROR: ${e.message}\n`);
      }
      done++; setProgress(Math.round(done/total*100));
      log(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...\nâœ… Ù†Ø¬Ø­: ${ok} | âŒ ÙØ´Ù„: ${fail}\nğŸ“º Ù…Ø³ØªØ®Ø±Ø¬: ${entries.length}`);
      setReport(reportLines.join("\n"));
    }

    // Files
    for(const f of files){
      const t=await readFile(f);
      const ext=countExtinf(t);
      const html=looksLikeHTML(t);
      const parsed=parseM3U(t);
      entries.push(...parsed);

      reportLines.push(
        `ğŸ“„ FILE: ${f.name}\n` +
        `   - HTMLØŸ ${html ? "Ù†Ø¹Ù…" : "Ù„Ø§"}\n` +
        `   - EXTINF: ${ext}\n` +
        `   - Parsed URLs: ${parsed.length}\n`
      );

      done++; setProgress(Math.round(done/total*100));
      log(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...\nâœ… Ù†Ø¬Ø­: ${ok} | âŒ ÙØ´Ù„: ${fail}\nğŸ“º Ù…Ø³ØªØ®Ø±Ø¬: ${entries.length}`);
      setReport(reportLines.join("\n"));
    }

    // Keep only real stream-like urls
    const before=entries.length;
    entries = entries.filter(e => /^(https?|rtmp|rtsp|udp):/i.test(e.url));
    const removed = before - entries.length;

    if($("dedup").checked){
      const s=new Set();
      entries=entries.filter(e=>!s.has(e.url)&&(s.add(e.url),true));
    }
    if($("sort").checked){
      entries.sort((a,b)=>(a.ext||"").localeCompare(b.ext||""));
    }

    // Always show final report
    reportLines.push(`\nâ€” SUMMARY â€”\nParsed total: ${before}\nRemoved non-URLs: ${removed}\nFinal entries: ${entries.length}\nOK URLs: ${ok}\nFailed URLs: ${fail}\n`);
    setReport(reportLines.join("\n"));

    if(entries.length===0){
      log(
        "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª.\n" +
        "Ø§ÙØªØ­ (ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ) Ø¨Ø§Ù„Ø£Ø³ÙÙ„ ÙˆØ³ØªØ¹Ø±Ù Ø§Ù„Ø³Ø¨Ø¨.\n" +
        "ØºØ§Ù„Ø¨Ù‹Ø§: HTMLØŸ Ù†Ø¹Ù… = Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØ³ RAW."
      );
      return;
    }

    // build output
    let out="#EXTM3U\n";
    for(const e of entries){
      out += (e.ext||"#EXTINF:-1,Unknown") + "\n" + e.url + "\n";
    }

    log(`âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­\nğŸ“º Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: ${entries.length}\nâœ… Ø±ÙˆØ§Ø¨Ø· Ù†Ø¬Ø­Øª: ${ok} | âŒ ÙØ´Ù„Øª: ${fail}`);

    if(downloadFile){
      download($("outname").value, out);

      const modal=$("successModal");
      modal.style.display="flex";
      setTimeout(()=>modal.style.display="none",2500);
    }

  } finally {
    $("start").disabled=false;
    $("diag").disabled=false;
  }
}

$("start").onclick = ()=> run({downloadFile:true});
$("diag").onclick  = ()=> run({downloadFile:false});
</script>
</body>
</html>
