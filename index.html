<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>M3U Tool</title>

<style>
:root{
  --bg:#0b0f17; --card:#ffffff10; --line:#ffffff20; --text:#e9eef7; --muted:#b7bfd0;
  --accent:#7c5cff; --ok:#22c55e; --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);padding:18px}
.card{max-width:900px;margin:auto;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px}
h1{margin:0 0 6px}
.muted{color:var(--muted);font-size:13px}
label{display:block;margin-top:14px;font-weight:700}
textarea,input{width:100%;padding:12px;margin-top:6px;border-radius:12px;border:1px solid var(--line);background:#00000040;color:var(--text)}
textarea{min-height:130px}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.row>*{flex:1;min-width:220px}
button{padding:12px;border-radius:14px;border:1px solid var(--accent);background:linear-gradient(135deg,var(--accent),#4f46e5);color:#fff;font-weight:800;cursor:pointer}
button:disabled{opacity:.6}
.progress-box{display:none;margin-top:14px}
.progress{height:14px;background:#00000050;border-radius:10px;overflow:hidden;border:1px solid var(--line)}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--ok));transition:width .3s}
.log{margin-top:14px;padding:12px;background:#00000040;border-radius:14px;border:1px solid var(--line);white-space:pre-wrap;font-size:13px}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.modal-content{
  background:#0b0f17;border:1px solid #22c55e55;border-radius:20px;padding:30px 40px;text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,.5);animation:successBounce .45s ease-out;
}
.checkmark{width:80px;height:80px;border-radius:50%;background:#22c55e;color:#fff;font-size:44px;font-weight:900;display:flex;align-items:center;justify-content:center;margin:0 auto 14px}
.modal-text{font-size:16px;font-weight:800}
@keyframes successBounce{
  0%{transform:scale(.7);opacity:0}
  60%{transform:scale(1.05);opacity:1}
  80%{transform:scale(.97)}
  100%{transform:scale(1)}
}
</style>
</head>

<body>
<div class="card">
  <h1>ğŸ“º Ø£Ø¯Ø§Ø© Ø¯Ù…Ø¬ M3U</h1>
  <div class="muted">Ø¯Ù…Ø¬ Ø±ÙˆØ§Ø¨Ø· ÙˆÙ…Ù„ÙØ§Øª M3U + ØªØ´Ø®ÙŠØµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…ØµØ§Ø¯Ø± Ù„ÙŠØ³Øª M3U</div>

  <label>Ø±ÙˆØ§Ø¨Ø· M3U (ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø±):</label>
  <textarea id="urls" placeholder="Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· RAW Ù‡Ù†Ø§..."></textarea>

  <label>Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª M3U:</label>
  <input type="file" id="files" multiple accept=".m3u,.m3u8,text/plain">

  <div class="row">
    <label><input type="checkbox" id="dedup" checked> Ø­Ø°Ù Ø§Ù„Ù…ÙƒØ±Ø±</label>
    <label><input type="checkbox" id="sort"> ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ</label>
  </div>

  <div class="row">
    <input id="outname" value="merged.m3u">
    <button id="start">Ø¯Ù…Ø¬ ÙˆØªÙ†Ø²ÙŠÙ„</button>
  </div>

  <div class="progress-box" id="progressBox">
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
  </div>

  <div class="log" id="log">Ø¬Ø§Ù‡Ø².</div>
</div>

<div id="successModal" class="modal">
  <div class="modal-content">
    <div class="checkmark">âœ”</div>
    <div class="modal-text">ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­</div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
function log(msg){ $("log").textContent = msg; }
function setProgress(p){ $("progressBar").style.width = p + "%"; }

function looksLikeHTML(text){
  const t = (text || "").trim().slice(0, 300).toLowerCase();
  return t.startsWith("<!doctype html") || t.startsWith("<html") || t.includes("<head") || t.includes("<body");
}
function countExtinf(text){
  const m = (text || "").match(/^#EXTINF:/gm);
  return m ? m.length : 0;
}
function parseM3U(text){
  const lines = (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  let list=[], ext=null;
  for(const l of lines){
    if(l.startsWith("#EXTM3U")) continue;
    if(l.startsWith("#EXTINF")){ ext=l; continue; }
    if(l.startsWith("#")) continue;

    // âœ… Ù†Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­ØªÙ‰ Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ EXTINF
    list.push({ext: ext || "#EXTINF:-1,Unknown", url:l});
    ext=null;
  }
  return list;
}

async function fetchText(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.text();
}
async function readFile(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result||"");
    fr.onerror=rej;
    fr.readAsText(file);
  });
}
function download(name,text){
  const blob=new Blob([text],{type:"audio/x-mpegurl;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=(name && name.trim()) ? name.trim() : "merged.m3u";
  a.click();
  URL.revokeObjectURL(a.href);
}

$("start").onclick = async ()=>{
  const urls=$("urls").value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const files=[...$("files").files];
  const total=urls.length+files.length;

  if(!total){ log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø±. Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª."); return; }

  $("start").disabled=true;
  $("progressBox").style.display="block";
  setProgress(0);

  let entries=[], done=0, ok=0, fail=0;
  let report = [];

  try{
    for(const u of urls){
      try{
        const t = await fetchText(u);
        const extinfCount = countExtinf(t);
        const isHtml = looksLikeHTML(t);
        const parsed = parseM3U(t);
        entries.push(...parsed);
        ok++;
        report.push(`âœ… Ø±Ø§Ø¨Ø· Ù†Ø¬Ø­: ${u}\n   - EXTINF: ${extinfCount}\n   - Parsed URLs: ${parsed.length}\n   - HTMLØŸ ${isHtml ? "Ù†Ø¹Ù…" : "Ù„Ø§"}`);
      }catch(e){
        fail++;
        report.push(`âŒ Ø±Ø§Ø¨Ø· ÙØ´Ù„: ${u}\n   - Ø§Ù„Ø³Ø¨Ø¨: ${e.message}`);
      }
      done++; setProgress(Math.round(done/total*100));
      log(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ù…Ø¬...\nâœ… Ù†Ø¬Ø­: ${ok} | âŒ ÙØ´Ù„: ${fail}\nğŸ“º Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: ${entries.length}`);
    }

    for(const f of files){
      const t = await readFile(f);
      const extinfCount = countExtinf(t);
      const isHtml = looksLikeHTML(t);
      const parsed = parseM3U(t);
      entries.push(...parsed);
      report.push(`ğŸ“„ Ù…Ù„Ù: ${f.name}\n   - EXTINF: ${extinfCount}\n   - Parsed URLs: ${parsed.length}\n   - HTMLØŸ ${isHtml ? "Ù†Ø¹Ù…" : "Ù„Ø§"}`);
      done++; setProgress(Math.round(done/total*100));
      log(`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ù…Ø¬...\nâœ… Ù†Ø¬Ø­: ${ok} | âŒ ÙØ´Ù„: ${fail}\nğŸ“º Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: ${entries.length}`);
    }

    // ÙÙ„ØªØ±Ø©: Ù†Ø­ØªÙØ¸ ÙÙ‚Ø· Ø¨Ù…Ø§ ÙŠØ´Ø¨Ù‡ Ø±Ø§Ø¨Ø· (http/https/rtmp/rtsp/udpâ€¦)
    const before = entries.length;
    entries = entries.filter(e => /^(https?|rtmp|rtsp|udp):/i.test(e.url));
    const filtered = before - entries.length;

    if($("dedup").checked){
      const s=new Set();
      entries=entries.filter(e=>!s.has(e.url)&&(s.add(e.url),true));
    }
    if($("sort").checked){
      entries.sort((a,b)=>a.ext.localeCompare(b.ext));
    }

    if(entries.length===0){
      log(
        "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª.\n\n" +
        "Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§:\n" +
        "1) Ø§Ù„Ø±Ø§Ø¨Ø· Ù„ÙŠØ³ RAW ÙˆÙŠÙØ±Ø¬Ø¹ ØµÙØ­Ø© HTML.\n" +
        "2) Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØªØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø£Ùˆ Ù…Ø­Ø¬ÙˆØ¨.\n" +
        "3) Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ø¨ØµÙŠØºØ© M3U.\n\n" +
        "ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ:\n" + report.join("\n\n")
      );
      return;
    }

    let out="#EXTM3U\n";
    for(const e of entries){
      out += e.ext + "\n" + e.url + "\n";
    }

    log(
      "âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­\n" +
      "ğŸ“º Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ù†ÙˆØ§Øª: " + entries.length + "\n" +
      "âœ… Ø±ÙˆØ§Ø¨Ø· Ù†Ø¬Ø­Øª: " + ok + " | âŒ ÙØ´Ù„Øª: " + fail + "\n" +
      (filtered ? "ğŸ§¹ ØªÙ… Ø­Ø°Ù Ø£Ø³Ø·Ø± ØºÙŠØ± Ø±ÙˆØ§Ø¨Ø·: " + filtered + "\n" : "") +
      "\n(Ø¥Ù† Ø£Ø±Ø¯Øª ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø± Ø§Ù†Ø³Ø® ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´Ø®ÙŠØµ Ù…Ù† Ù‡Ù†Ø§.)"
    );

    download($("outname").value, out);

    const modal=$("successModal");
    modal.style.display="flex";
    setTimeout(()=>modal.style.display="none",2500);

  }catch(e){
    log("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: " + e.message);
  }finally{
    $("start").disabled=false;
  }
};
</script>
</body>
</html>
